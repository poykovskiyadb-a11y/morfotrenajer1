# streamlit_app.py
import streamlit as st
import pymorphy2
from random import choice

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
if 'stats' not in st.session_state:
    st.session_state.stats = {'correct': 0, 'total': 0}

# –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π
EXAMPLES = [
    {"phrase": "–∫—Ä–∞—Å–∏–≤–∞—è –¥–µ–≤—É—à–∫–∞", "target": "–∫—Ä–∞—Å–∏–≤–∞—è", "hint": "–ñ–µ–Ω—Å–∫–∏–π —Ä–æ–¥, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ, –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂"},
    {"phrase": "—Ö–æ—Ä–æ—à–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞", "target": "—Ö–æ—Ä–æ—à–µ–≥–æ", "hint": "–†–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂, –º—É–∂—Å–∫–æ–π —Ä–æ–¥"},
    {"phrase": "—Å–∞–º—ã–π —É–º–Ω—ã–π —É—á–µ–Ω–∏–∫", "target": "—É–º–Ω—ã–π", "hint": "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å"},
    {"phrase": "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –∫–Ω–∏–≥–∏", "target": "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ", "hint": "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å"},
    {"phrase": "—Å–∏–Ω–µ–µ –Ω–µ–±–æ", "target": "—Å–∏–Ω–µ–µ", "hint": "–°—Ä–µ–¥–Ω–∏–π —Ä–æ–¥, –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂"},
    {"phrase": "–≤ –±–æ–ª—å—à–æ–º –¥–æ–º–µ", "target": "–±–æ–ª—å—à–æ–º", "hint": "–ü—Ä–µ–¥–ª–æ–∂–Ω—ã–π –ø–∞–¥–µ–∂, –º—É–∂—Å–∫–æ–π —Ä–æ–¥"},
    {"phrase": "–Ω–æ–≤—ã–µ –º–∞—à–∏–Ω—ã", "target": "–Ω–æ–≤—ã–µ", "hint": "–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ, –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂"},
]

# –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∑–∞–¥–∞–Ω–∏—è ‚Äî –î–û–õ–ñ–ù–ê –ë–´–¢–¨ –û–ë–™–Ø–í–õ–ï–ù–ê –î–û –í–´–ó–û–í–ê
def reset_task():
    example = choice(EXAMPLES)
    st.session_state.current_phrase = example["phrase"]
    st.session_state.current_word = example["target"]
    st.session_state.hint = example["hint"]
    st.session_state.parsed = morph.parse(example["target"])[0]
    st.session_state.guessed = {
        "part": None,
        "base": None,
        "type": None,
        "stepen": None,
        "rod": None,
        "chislo": None,
        "pad": None,
        "role": None,
    }
    st.session_state.checked = False

# –°–æ–∑–¥–∞—ë–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ü–û–°–õ–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π, –Ω–æ –î–û –≤—ã–∑–æ–≤–∞ reset_task
morph = pymorphy2.MorphAnalyzer()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
if 'current_word' not in st.session_state:
    reset_task()

# === –î–ê–õ–ï–ï –ò–î–Å–¢ –ò–ù–¢–ï–†–§–ï–ô–° ===
st.title("üîç –¢—Ä–µ–Ω–∞–∂—ë—Ä: –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ")

# –ú–µ–Ω—é
tab1, tab2, tab3 = st.tabs(["üìö –ó–∞–¥–∞–Ω–∏–µ", "üìò –¢–µ–æ—Ä–∏—è", "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"])

with tab1:
    st.markdown(f"### üìÑ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: *{st.session_state.current_phrase}*")
    st.markdown(f"**–†–∞–∑–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ:** `{st.session_state.current_word}`")
    st.caption(f"–ü–æ–¥—Å–∫–∞–∑–∫–∞: {st.session_state.hint}")

    p = st.session_state.parsed

    # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    correct = {
        "part": "–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ",
        "base": p.normal_form,
        "type": "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ" if 'Qual' in p.tag else "–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ" if 'Rel' in p.tag else "–ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω–æ–µ",
        "stepen": "—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è" if 'Comp' in p.tag else "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è" if 'Supr' in p.tag else "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è",
        "rod": p.tag.gender,
        "chislo": p.tag.number,
        "pad": p.tag.case,
        "role": "–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ",
    }

    rod_names = {"masc": "–º—É–∂—Å–∫–æ–π", "femn": "–∂–µ–Ω—Å–∫–∏–π", "neut": "—Å—Ä–µ–¥–Ω–∏–π", None: "‚Äî"}
    chislo_names = {"sing": "–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ", "plur": "–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ", None: "‚Äî"}
    pad_names = {
        "nomn": "–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π", "gent": "—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π", "datv": "–¥–∞—Ç–µ–ª—å–Ω—ã–π",
        "accs": "–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π", "ablt": "—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π", "loct": "–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π", None: "‚Äî"
    }

    st.markdown("### üîç –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:")
    st.session_state.guessed["part"] = st.radio("1. –ß–∞—Å—Ç—å —Ä–µ—á–∏:", ["‚Äî", "–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ", "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ", "–Ω–∞—Ä–µ—á–∏–µ", "–º–µ—Å—Ç–æ–∏–º–µ–Ω–∏–µ"], key="part")
    st.session_state.guessed["base"] = st.radio("2. –ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞:", ["‚Äî", p.normal_form, p.normal_form[:-2] + "–∏–π", p.normal_form + "–µ", "–¥—Ä—É–≥–æ–µ"], key="base")
    st.session_state.guessed["type"] = st.radio("3. –í–∏–¥ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ:", ["‚Äî", "–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ", "–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ", "–ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω–æ–µ"], key="type")
    st.session_state.guessed["stepen"] = st.radio("4. –°—Ç–µ–ø–µ–Ω—å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:", ["‚Äî", "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è", "—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è", "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è"], key="stepen")
    st.session_state.guessed["rod"] = st.radio("5. –†–æ–¥:", ["‚Äî", "–º—É–∂—Å–∫–æ–π", "–∂–µ–Ω—Å–∫–∏–π", "—Å—Ä–µ–¥–Ω–∏–π"], key="rod")
    st.session_state.guessed["chislo"] = st.radio("6. –ß–∏—Å–ª–æ:", ["‚Äî", "–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ", "–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ"], key="chislo")
    st.session_state.guessed["pad"] = st.radio("7. –ü–∞–¥–µ–∂:", ["‚Äî", "–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π", "—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π", "–¥–∞—Ç–µ–ª—å–Ω—ã–π", "–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π", "—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π", "–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π"], key="pad")
    st.session_state.guessed["role"] = st.radio("8. –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è —Ä–æ–ª—å:", ["‚Äî", "–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", "–ø–æ–¥–ª–µ–∂–∞—â–µ–µ", "—Å–∫–∞–∑—É–µ–º–æ–µ", "–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ"], key="role")

    col1, col2 = st.columns(2)
    with col1:
        if st.button("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å"):
            st.session_state.checked = True
            correct_count = 0
            for key in correct:
                if st.session_state.guessed[key] == correct[key]:
                    correct_count += 1
            is_full = correct_count == len(correct)
            st.session_state.stats['total'] += 1
            if is_full:
                st.session_state.stats['correct'] += 1
                st.success("üéâ –û—Ç–ª–∏—á–Ω–æ! –ü–æ–ª–Ω—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä!")
            else:
                st.info(f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ {correct_count} –∏–∑ {len(correct)} –ø—É–Ω–∫—Ç–æ–≤.")
                if st.session_state.guessed["part"] != correct["part"]:
                    st.error("–ß–∞—Å—Ç—å —Ä–µ—á–∏: –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ")
                if st.session_state.guessed["base"] != correct["base"]:
                    st.error(f"–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞: {correct['base']}")
                if st.session_state.guessed["type"] != correct["type"]:
                    st.error(f"–í–∏–¥: {correct['type']}")
                if st.session_state.guessed["stepen"] != correct["stepen"]:
                    st.error(f"–°—Ç–µ–ø–µ–Ω—å: {correct['stepen']}")
                if st.session_state.guessed["rod"] != rod_names.get(correct["rod"]):
                    st.error(f"–†–æ–¥: {rod_names.get(correct['rod'])}")
                if st.session_state.guessed["chislo"] != chislo_names.get(correct["chislo"]):
                    st.error(f"–ß–∏—Å–ª–æ: {chislo_names.get(correct['chislo'])}")
                if st.session_state.guessed["pad"] != pad_names.get(correct["pad"]):
                    st.error(f"–ü–∞–¥–µ–∂: {pad_names.get(correct['pad'])}")
                if st.session_state.guessed["role"] != correct["role"]:
                    st.error(f"–†–æ–ª—å: {correct['role']}")

    with col2:
        if st.button("üîÑ –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ"):
            reset_task()
            st.rerun()

with tab2:
    st.markdown("## üìò –¢–µ–æ—Ä–∏—è: –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ")
    st.markdown("""
    ### 1. **–ß–∞—Å—Ç—å —Ä–µ—á–∏:** –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ
    –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã: *–∫–∞–∫–æ–π? —á–µ–π?*

    ### 2. **–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞**
    –ò–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ, –º—É–∂—Å–∫–æ–π —Ä–æ–¥: *—Ö–æ—Ä–æ—à–∏–π, –∫—Ä–∞—Å–∏–≤—ã–π*

    ### 3. **–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**
    - **–í–∏–¥ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ:**
      - *–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ* ‚Äî –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ (*—É–º–Ω—ã–π*)
      - *–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ* ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫ —á–µ—Ä–µ–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ (*–¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π*)
      - *–ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω–æ–µ* ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å (*–º–∞–º–∏–Ω–æ*)
    - **–°—Ç–µ–ø–µ–Ω—å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:**
      - *–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è* ‚Äî –æ–±—ã—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (*–≤—ã—Å–æ–∫–∏–π*)
      - *—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è* ‚Äî (*–≤—ã—à–µ, —É–º–Ω–µ–µ*)
      - *–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è* ‚Äî (*—Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π*)

    ### 4. **–ù–µ–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**
    - **–†–æ–¥:** –º—É–∂—Å–∫–æ–π, –∂–µ–Ω—Å–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π  
    - **–ß–∏—Å–ª–æ:** –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ  
    - **–ü–∞–¥–µ–∂:** –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π, —Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –¥–∞—Ç–µ–ª—å–Ω—ã–π, –≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π, —Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π, –ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π

    ### 5. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è —Ä–æ–ª—å**
    –ß–∞—â–µ –≤—Å–µ–≥–æ ‚Äî **–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: *–∫—Ä–∞—Å–∏–≤–∞—è (–∫–∞–∫–∞—è?) –¥–µ–≤—É—à–∫–∞*
    """)

with tab3:
    st.markdown("## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    if st.session_state.stats['total'] > 0:
        perc = st.session_state.stats['correct'] / st.session_state.stats['total'] * 100
        st.metric("–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤", f"{st.session_state.stats['correct']} / {st.session_state.stats['total']}")
        st.progress(perc / 100)
        st.markdown(f"**–¢–æ—á–Ω–æ—Å—Ç—å:** {perc:.1f}%")
    else:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤. –†–µ—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ.")

    if st.button("üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"):
        st.session_state.stats = {'correct': 0, 'total': 0}
        reset_task()
        st.rerun()
